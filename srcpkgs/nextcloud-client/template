# Template file for 'nextcloud-client'
pkgname=nextcloud-client
version=3.15.3
revision=1
build_style=cmake
configure_args="-Wno-dev -DBUILD_UPDATER=NO -DUNIT_TESTING=1
 $(vopt_if webengine '' -DBUILD_WITH_WEBENGINE=OFF)
 -DKDE_INSTALL_QTPLUGINDIR=lib/qt6/plugins"
hostmakedepends="pkg-config extra-cmake-modules qt6-base qt6-tools inkscape"
makedepends="qt6-base-private-devel qt6-qt5compat-devel qt6-declarative-devel
 qtkeychain-qt6-devel qt6-websockets-devel qt6-svg-devel
 $(vopt_if webengine qt6-webengine-devel)
 kf6-karchive-devel kf6-kguiaddons-devel kf6-kio-devel cmocka-devel"
conf_files="/etc/Nextcloud/sync-exclude.lst"
short_desc="NextCloud Desktop client"
maintainer="Rodrigo Oliveira <mdkcore@qtrnn.io>"
license="GPL-2.0-or-later"
homepage="https://nextcloud.com/clients/"
changelog="https://github.com/nextcloud/desktop/releases"
distfiles="https://github.com/nextcloud/desktop/archive/v${version}.tar.gz"
checksum=5a4b12604c84b8986f2aee7462bb9683fb01f4ae28ee9d6882068cb9cac45773
# https://github.com/void-linux/void-packages/pull/33358#discussion_r724518549

build_options="webengine"
desc_option_webengine="Build Qt5 WebEngine support"

if [ "$XBPS_TARGET_WORDSIZE" = 64 ]; then
	build_options_default+=" webengine"
fi

nextcloud-client-kwallet_package() {
	short_desc+=" - kwallet credential backend"
	depends="nextcloud-client>=${version}_${revision} kwallet"
	pkg_install() {
		vbin ${FILESDIR}/kwallet/nextcloud.kwallet
		vmkdir usr/share/applications
		cp build/src/gui/com.nextcloud.desktopclient.nextcloud.desktop \
		   ${DESTDIR}/usr/share/applications/nextcloud-kwallet.desktop
		vsed -i -e 's,^Exec=.*,Exec=/usr/bin/nextcloud.kwallet,' \
		     -e 's,\(^Name=.*\),\1 - use kwallet,' \
		     -e 's,\(^Comment=.*\),\1 - use kwallet credential storage,' \
		     -e '/^# Translations/,$d' \
		     ${DESTDIR}/usr/share/applications/nextcloud-kwallet.desktop
		vdoc ${FILESDIR}/kwallet/README.voidlinux
	}
}

nextcloud-client-dolphin_package() {
	short_desc+=" - KDE dolphin integration"
	depends="nextcloud-client>=${version}_${revision}"
	pkg_install() {
		vmove usr/lib/libnextclouddolphinpluginhelper.so
		vmove usr/lib/qt6
	}
}

nextcloud-client-devel_package() {
	depends="nextcloud-client>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/libnextcloudsync.so
	}
}
