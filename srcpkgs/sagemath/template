# Template file for 'sagemath'
pkgname=sagemath
version=9.5.rc4
revision=1
wrksrc=sage-$version
build_style=configure
configure_args="--enable-build-as-root --with-system-python3
 --enable-system-site-packages --disable-doc --with-sage-venv=no"
depends="giac git FlintQS zn_poly sympow
 pari-elldata-small pari-galdata pari-galpol-small pari-seadata-small
 flintlib-devel gsl-devel ntl-devel eclib-devel pari-devel mpfr-devel
 m4ri-devel gd-devel libpng-devel fflas-ffpack pkg-config gcc-fortran
 linbox-devel gfan nauty-devel palp tachyon maxima-ecl
 "
short_desc="Open source mathematics software"
maintainer="Gonzalo Tornar√≠a <tornaria@cmat.edu.uy>"
license="GPL-3.0-only, GPL-2.0-or-later, CC-BY-SA-3.0, custom:Various free"
homepage="http://sagemath.org/"
distfiles="https://github.com/sagemath/sage/archive/refs/tags/$version.tar.gz"
checksum=9d5053b83648e9fac5590516a39871ac57524ab9d37102206977e0010e61bb6e
python_version=3
patch_args="-F0 -Np1"

# path where sage will be installed
_SAGE_ROOT=/usr/lib/sage-${version}

# Skip these sage packages: they are not needed
_spkg_skip="appnope fonttools importlib_resources pycygwin
 setuptools_scm_git_archive setuptools_wheel sphinxcontrib_websupport
 pplpy_doc vcversioner ratpoints
 jmol mathjax sagenb_export thebe sagetex jupyter_jsmol rpy2 threejs"

# Force use these sage packages from system
_spkg_system="cppy cython cysignals cypari pplpy fpylll memory_allocator
 primecountpy
 argcomplete argon2_cffi attrs backcall beniget bleach certifi
 cffi charset_normalizer cvxopt cycler dateutil debugpy decorator defusedxml
 docutils entrypoints flit_core gast gmpy2 html5lib idna
 importlib_metadata importlib_resources ipykernel ipython ipython_genutils
 ipywidgets jedi jinja2 jsonschema jupyter_client jupyter_core
 jupyterlab_pygments kiwisolver markupsafe matplotlib matplotlib_inline mistune
 mpmath nbclient nbconvert nbformat nest_asyncio networkx notebook numpy
 packaging pandocfilters parso pexpect pickleshare pillow pip pkgconfig pluggy
 ply prometheus_client prompt_toolkit ptyprocess py pybind11 pycparser pygments
 pyparsing pyrsistent pythran pytz pyzmq requests scipy send2trash setuptools
 setuptools_scm simplegeneric six sympy
 terminado testpath texttable tomli tornado traitlets typing_extensions tzlocal
 urllib3 wcwidth webencodings wheel widgetsnbextension zipp
 linbox gap maxima"
### Not required with --disable-doc
#alabaster babel imagesize snowballstemmer sphinx
#sphinxcontrib_applehelp sphinxcontrib_devhelp sphinxcontrib_htmlhelp
#sphinxcontrib_jsmath sphinxcontrib_qthelp sphinxcontrib_serializinghtml

# Databases to be used from system
_spkg_db="combinatorial_designs conway_polynomials elliptic_curves graphs
 polytopes_db"

for spkg in $_spkg_skip; do
	configure_args+=" sage_spkg_install_$spkg=no"
	configure_args+=" sage_require_$spkg=no"
done

for spkg in $_spkg_system; do
	configure_args+=" sage_spkg_install_$spkg=no"
	configure_args+=" sage_require_$spkg=yes"
done

for spkg in $_spkg_db; do
	configure_args+=" sage_spkg_install_$spkg=no"
	configure_args+=" sage_require_$spkg=yes"
	depends+=" sage-data-$spkg"
	checkdepends+=" sage-data-$spkg"
done

# for now, just build native; we'll worry about cross later
# besides, some dependencies are nocross (e.g. ntl)
nocross=yes

# for now, to make install faster
nostrip=yes

# don't shlib_provide anything
noshlibprovides=yes

# compile python code in sage venv
pycompile_dirs="$_SAGE_ROOT"

post_extract() {
	# sage wants to be built in place so let $wrksrc be a symlink
	rm -rf $_SAGE_ROOT
	mv -T $wrksrc $_SAGE_ROOT
	ln -srfT $_SAGE_ROOT $wrksrc
}

do_clean() {
	rm -rf $wrksrc $_SAGE_ROOT
}

post_patch() {
	# these are unused and nothing else uses ratpoints spkg
	rm src/sage/libs/ratpoints.{pyx,pxd}
	./bootstrap
}

post_configure() {
	# we set some variables, right after configure has created sage_conf.py
	cat <<-EOF >> pkgs/sage-conf/sage_conf.py
	GAP_ROOT_DIR = "/usr/share/gap"
	GAP_SO = "$(objdump -p /usr/lib/libgap.so | awk '/SONAME/{print $2}')"
	MAXIMA = "maxima -l ecl"
	MAXIMA_FAS = ""
	CONWAY_POLYNOMIALS_DATA_DIR = "/usr/share/sagemath/conway_polynomials"
	GRAPHS_DATA_DIR = "/usr/share/sagemath/graphs"
	ELLCURVE_DATA_DIR = "/usr/share/sagemath/ellcurves"
	POLYTOPE_DATA_DIR = "/usr/share/sagemath/reflexive_polytopes"
	COMBINATORIAL_DESIGN_DATA_DIR = "/usr/share/sagemath/combinatorial_designs"
	CREMONA_MINI_DATA_DIR = "/usr/share/sagemath/cremona"
	CREMONA_LARGE_DATA_DIR = "/usr/share/sagemath/cremona"
	EOF
	cat <<-EOF >> src/bin/sage-env
	unset MAXIMA_PREFIX
	EOF
}

do_install() {
	vlicense COPYING.txt
	vdoc README.md
	vmkdir $_SAGE_ROOT
	vcopy "VERSION.txt sage" $_SAGE_ROOT
	vmkdir $_SAGE_ROOT/local
	for f in pyvenv.cfg bin lib share; do
		vcopy local/$f $_SAGE_ROOT/local
	done
	vmkdir $_SAGE_ROOT/src
	vcopy src/bin $_SAGE_ROOT/src
	ln -sf ../local/lib/python3.10/site-packages/{sage,sage_setup} \
		${DESTDIR}/$_SAGE_ROOT/src

	# symlink main binary
	vmkdir usr/bin
	# for now use sage-${version}_${revision} so it doesn't override
	# other sage installed in the system
	ln -sfT $_SAGE_ROOT/sage ${DESTDIR}/usr/bin/sage-${version}
	ln -sfT sage-${version} ${DESTDIR}/usr/bin/sage
}

do_check() {
	if [ -f ${XBPS_DISTDIR}/sagemath-check ] ; then
		_test_files=$(sed -e 's/#.*//;/^\s*$/d' ${XBPS_DISTDIR}/sagemath-check)
	fi
	if [ -z "$_test_files" ]; then
		_test_files=--all
	fi
	cp ${FILESDIR}/timings2.json .
	_test_args="--stats_path=timings2.json"
	if [ "$XBPS_CHECK_PKGS" = full ]; then
		_test_args+=" --long --warn-long 60.0"
	else
		_test_args+=" --warn-long 30.0"
	fi
	if [ "$XBPS_BUILD_ENVIRONMENT" = "void-packages-ci" ]; then
		# for CI use a predictable random seed
		_test_args+=" --random-seed=0"
	fi
	# since make check will build the docs, run test like this instead
	./sage -tp ${XBPS_MAKEJOBS} ${_test_args} ${_test_files}
}

### copied from sage-deps, to be kept in sync

# hard dependencies
makedepends="gcc make m4 perl binutils git tar libgomp-devel"

# recommended dependencies
makedepends+=" gcc-fortran openssl-devel"

# bootstrap dependencies
makedepends+=" automake gettext gettext-devel"

# other host dependencies
makedepends+=" cmake curl git ninja pandoc patch pkg-config python3 tox"

# standard dependencies
makedepends+="
 CoinMP-devel R arb-devel boost-devel bzip2-devel ecl eclib-devel
 ecm-devel flintlib-devel freetype-devel gc-devel gd-devel giac-devel
 glpk-devel gmp-devel gmpxx-devel gp2c graphviz graphviz-devel gsl-devel
 isl-devel libatomic_ops-devel libcurl-devel libffi-devel libmpc-devel
 libpng-devel libxml2-devel mpfr-devel ncurses-devel openblas-devel
 pari-devel pari-elldata-small pari-galdata pari-galpol-small
 pari-seadata pcre-devel perl-File-Slurp perl-JSON perl-Term-ReadKey
 perl-Term-ReadLine-Gnu perl-XML-LibXML perl-XML-LibXSLT
 perl-XML-Writer ppl-devel python3-devel readline-devel sqlite-devel
 zeromq-devel zlib-devel
 FlintQS SuiteSparse-devel cddlib-devel fflas-ffpack fplll-devel gf2x-devel
 givaro-devel igraph-devel iml-devel lcalc-devel linbox-devel
 m4ri-devel m4rie-devel mpfi-devel ntl-devel perl-SVG rankwidth-devel
 singular sympow zn_poly symmetrica-devel planarity-devel qhull libqhull-devel
 gengetopt texinfo
 brial-devel cliquer-devel gfan libbraiding-devel libhomfly-devel
 lrcalc-devel nauty-devel palp tachyon
 maxima-ecl primesieve-devel primecount-devel gap-devel
"

# optional dependencies
#makedepends+="
# ffmpeg ImageMagick
#"

# TODO: optional
# 4ti2 coxeter3 libsemigroups lrslib pdf2svg perl_mongodb polymake

# python packages for trac-29665
_sage_python3_modules="
 python3-Jinja2 python3-MarkupSafe python3-Pillow
 python3-Pygments python3-argcomplete
 python3-argon2 python3-attrs python3-backcall python3-beniget
 python3-bleach python3-certifi python3-cffi python3-charset-normalizer
 python3-cycler python3-dateutil python3-decorator python3-defusedxml
 python3-docutils python3-entrypoints python3-flit_core python3-gast
 python3-gmpy2 python3-html5lib python3-idna
 python3-importlib_metadata python3-ipython python3-ipython_genutils
 python3-ipython_ipykernel python3-jedi python3-jsonschema
 python3-jupyter_client python3-jupyter_core python3-jupyter_ipywidgets
 python3-jupyter_nbconvert python3-jupyter_nbformat
 python3-jupyter_notebook python3-jupyterlab_pygments python3-kiwisolver
 python3-matplotlib python3-matplotlib-inline python3-mistune
 python3-mpmath python3-nbclient python3-nest_asyncio python3-networkx
 python3-numpy python3-packaging python3-pandocfilters python3-parsing
 python3-parso python3-pexpect python3-pickleshare python3-pip
 python3-pkgconfig python3-pluggy python3-ply python3-prometheus_client
 python3-prompt_toolkit python3-ptyprocess python3-py python3-pybind11
 python3-pycparser python3-pyrsistent python3-pytz python3-pyzmq
 python3-requests python3-scipy python3-send2trash python3-setuptools
 python3-setuptools_scm python3-simplegeneric python3-six
 python3-sympy python3-terminado
 python3-testpath python3-texttable python3-toml python3-tomli
 python3-tornado python3-traitlets python3-typing_extensions
 python3-tzlocal python3-urllib3 python3-wcwidth python3-webencodings
 python3-wheel python3-zipp pythran

 python3-cvxopt python3-cppy python3-Cython python3-cysignals python3-cypari2
 python3-pplpy python3-fpylll python3-primecountpy python3-memory_allocator
"

# python packages are build and runtime dependencies
makedepends+=" $_sage_python3_modules"
depends+=" $_sage_python3_modules"
