# Template file for 'sagemath'
pkgname=sagemath
version=9.5.beta8
revision=1
wrksrc=sage-$version
build_style=configure
configure_args="--enable-build-as-root"
make_check_target=ptest
# for now skip building docs
make_build_target=build
depends="giac git FlintQS zn_poly sympow
 pari-elldata-small pari-galdata pari-galpol-small pari-seadata-small
 flintlib-devel gsl-devel ntl-devel eclib-devel pari-devel mpfr-devel
 m4ri-devel gd-devel libpng-devel fflas-ffpack pkg-config gcc-fortran
 linbox-devel gfan nauty-devel palp tachyon maxima-ecl
 "
short_desc="Open source mathematics software"
maintainer="Gonzalo Tornar√≠a <tornaria@cmat.edu.uy>"
license="GPL-3.0-or-later"
homepage="http://sagemath.org/"
distfiles="https://mirrors.mit.edu/sage/src/sage-$version.tar.gz"
checksum=124f3d23ce6442ecc84ed98e3c035e0d00c8261c3125712e4742c32e731d13de
python_version=3

# path where sage will be installed
_SAGE_ROOT=/usr/lib/sage-${version}

case ${version} in
	# url for devel is different
	*.beta*|*.rc*) distfiles=${distfiles/sage\/src/sage\/devel} ;;
esac

# for now, skip check in ci, since we still have a few tests failing
#make_check=ci-skip

# for now, just build native; we'll worry about cross later
# besides, some dependencies are nocross (e.g. ntl)
nocross=yes

# for now, to make install faster
nostrip=yes

# don't shlib_provide anything
noshlibprovides=yes

# don't rewrite python shebang as sage uses its own python (for now)
_no_python_shebang=yes

post_extract() {
	# sage wants to be built in place so let $wrksrc be a symlink
	rm -rf $_SAGE_ROOT
	mv -T $wrksrc $_SAGE_ROOT
	ln -sfT $_SAGE_ROOT $wrksrc
}

do_clean() {
	rm -rf $wrksrc $_SAGE_ROOT
}

pre_configure() {
	./bootstrap
}

# DISABLED pytest since it brings more harm than good
# it seems currently all it does is to look for files matching
# *_test.py and run pytest on those, but I don't think these are meant
# to be run on pytest (and one even gives a failure...)
#
# post_build() {
# 	# install pytest for more tests
# 	./sage -i pytest
# }

do_install() {
	vcopy $_SAGE_ROOT usr/lib/
	# cleanup: upstream sources and build artifacts
	rm -rf ${DESTDIR}/$_SAGE_ROOT/upstream
	rm -rf ${DESTDIR}/$_SAGE_ROOT/pkgs/*/build
	# symlink main binary
	vmkdir usr/bin
	# for now use sage-${version}_${revision} so it doesn't override
	# other sage installed in the system
	ln -sfT $_SAGE_ROOT/sage ${DESTDIR}/usr/bin/sage-${version}_${revision}
}

do_check() {
	TEST=--all
	if [ -f ${XBPS_DISTDIR}/sagemath-check ] ; then
		TEST="$(grep -v "^#" ${XBPS_DISTDIR}/sagemath-check)"
	fi
	# the default is "sage,dochtml,optional,build", we skip dochtml
	OPT="--optional sage,optional,build"
	# since make check will build the docs, run test like this instead
	./sage -tp ${XBPS_MAKEJOBS} ${OPT} ${TEST}
}

### copied from sage-deps, to be kept in sync

# hard dependencies
makedepends+=" gcc make m4 perl binutils git tar libgomp-devel"

# recommended dependencies
makedepends+=" gcc-fortran openssl-devel"

# bootstrap dependencies
makedepends+=" automake gettext gettext-devel"

# other host dependencies
makedepends+=" cmake curl git ninja pandoc patch pkg-config python3 tox"

# already in void
makedepends+="
 CoinMP-devel R arb-devel boost-devel bzip2-devel ecl eclib-devel
 ecm-devel flintlib-devel freetype-devel gc-devel gd-devel giac-devel
 glpk-devel gmp-devel gmpxx-devel gp2c graphviz-devel gsl-devel isl-devel
 libatomic_ops-devel libcurl-devel libffi-devel libmpc-devel
 libpng-devel libxml2-devel mpfr-devel ncurses-devel openblas-devel
 pari-devel pari-elldata-small pari-galdata pari-galpol-small
 pari-seadata pcre-devel perl-File-Slurp perl-JSON perl-Term-ReadKey
 perl-Term-ReadLine-Gnu perl-XML-LibXML perl-XML-LibXSLT
 perl-XML-Writer ppl-devel python3-devel readline-devel sqlite-devel
 zeromq-devel zlib-devel
 FlintQS SuiteSparse-devel cddlib-devel fflas-ffpack fplll-devel gf2x-devel
 givaro-devel igraph-devel iml-devel lcalc-devel linbox-devel
 m4ri-devel m4rie-devel mpfi-devel ntl-devel perl-SVG rankwidth-devel
 singular sympow zn_poly symmetrica-devel planarity-devel qhull libqhull-devel
 gengetopt texinfo
 brial-devel cliquer-devel gfan libbraiding-devel libhomfly-devel
 lrcalc-devel nauty-devel palp tachyon
 maxima-ecl
"

# TODO: optional
# 4ti2 coxeter3 libsemigroups lrslib pdf2svg perl_mongodb polymake
