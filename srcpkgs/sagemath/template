# Template file for 'sagemath'
pkgname=sagemath
version=9.5.rc1
revision=1
wrksrc=sage-$version
build_style=configure
configure_args="--enable-build-as-root --with-system-python3
 --enable-system-site-packages"
make_check_target=ptest
# for now skip building docs
make_build_target=build
depends="giac git FlintQS zn_poly sympow
 pari-elldata-small pari-galdata pari-galpol-small pari-seadata-small
 flintlib-devel gsl-devel ntl-devel eclib-devel pari-devel mpfr-devel
 m4ri-devel gd-devel libpng-devel fflas-ffpack pkg-config gcc-fortran
 linbox-devel gfan nauty-devel palp tachyon maxima-ecl
 "
short_desc="Open source mathematics software"
maintainer="Gonzalo Tornar√≠a <tornaria@cmat.edu.uy>"
license="GPL-3.0-only, GPL-2.0-or-later, CC-BY-SA-3.0, custom:Various free"
homepage="http://sagemath.org/"
distfiles="https://github.com/sagemath/sage/archive/refs/tags/$version.tar.gz"
checksum=b015c54f7411669ef70bac2b2fde260e7f45724bcff170957b1f9fd08131f2c3
python_version=3

build_options="debug"
desc_option_debug="Build with debug symbols"

# path where sage will be installed
_SAGE_ROOT=/usr/lib/sage-${version}

_SAGE_UPSTREAM_MIRROR=https://mirrors.mit.edu/sage/spkg/upstream

# packages were sage is the upstream
_upstream="
 ${_SAGE_UPSTREAM_MIRROR}/combinatorial_designs/combinatorial_designs-20140630.tar.bz2
 ${_SAGE_UPSTREAM_MIRROR}/conway_polynomials/conway_polynomials-0.5.tar.bz2
 ${_SAGE_UPSTREAM_MIRROR}/elliptic_curves/elliptic_curves-0.8.1.tar.bz2
 ${_SAGE_UPSTREAM_MIRROR}/jmol/jmol-14.29.52.tar.bz2
 ${_SAGE_UPSTREAM_MIRROR}/mathjax/mathjax-2.7.4.tar.gz
 ${_SAGE_UPSTREAM_MIRROR}/polytopes_db/polytopes_db-20170220.tar.bz2
 ${_SAGE_UPSTREAM_MIRROR}/ratpoints/ratpoints-2.1.3.tar.bz2
 ${_SAGE_UPSTREAM_MIRROR}/sagenb_export/sagenb_export-3.3.tar.gz
 ${_SAGE_UPSTREAM_MIRROR}/thebe/thebe-9624e0a0.zip
"
checksum+="
 c9486c6d7ec71da338589a6e301723be4e55e02dcfc41f8dba11a682e3b3482e
 d8f2788a85b1c2482cc4abe1a35d3da777445e21ec49b031d36b899e3c0deb17
 5fba5470d9d91f06282ed5edfc45bf0ea1c5f7c8d4837c46234b17be1481fd50
 ebf9cd42cd8e3839cf94ec11691b98a9b00917f3485a821291b76d7ecd6ffe9d
 169996cc6449c8d615043b07e1f20e9e3cd821de2325b5a250ef42142ea654b3
 cb788bdfca6e00864ec0bfa67932a68ae68bfeb9c527a91be90ad218026a0ce0
 edd3238422f47661b8a556f0241f36d619584d2f055efa1f96c749d1403abe1e
 b642321ccd94da4d04afa12f33b6cea7c8db289f3283c6e39b3a50131780bb5a
 cc1e407cbe0804f9644c207fecc074ed0fa389ba65f49da58e63fffe9bfe6923
"

# packages from pypi (python modules)
_upstream+="
 ${PYPI_SITE}/a/appnope/appnope-0.1.2.tar.gz
 ${PYPI_SITE}/c/cppy/cppy-1.1.0.tar.gz
 ${PYPI_SITE}/c/cypari2/cypari2-2.1.2.tar.gz
 ${PYPI_SITE}/c/cysignals/cysignals-1.11.2.tar.gz
 ${PYPI_SITE}/C/Cython/Cython-0.29.24.tar.gz
 ${PYPI_SITE}/f/fonttools/fonttools-4.28.4.zip
 ${PYPI_SITE}/j/jupyter_jsmol/jupyter_jsmol-0.2.4.tar.gz
 ${PYPI_SITE}/m/memory_allocator/memory_allocator-0.1.1.tar.gz
 ${PYPI_SITE}/p/pplpy/pplpy-0.8.6.tar.gz
 ${PYPI_SITE}/p/primecountpy/primecountpy-0.1.0.tar.gz
 ${PYPI_SITE}/P/PyCygwin/PyCygwin-0.1.tar.gz
 ${PYPI_SITE}/r/rpy2/rpy2-3.3.6.tar.gz
 ${PYPI_SITE}/s/setuptools/setuptools-59.2.0.tar.gz
 ${PYPI_SITE}/s/setuptools_scm_git_archive/setuptools_scm_git_archive-1.1.tar.gz
 ${PYPI_SITE}/s/sphinxcontrib-websupport/sphinxcontrib-websupport-1.2.1.tar.gz
 ${PYPI_SITE}/v/vcversioner/vcversioner-2.16.0.0.tar.gz
"
checksum+="
 dd83cd4b5b460958838f6eb3000c660b1f9caf2a5b1de4264e941512f603258a
 4eda6f1952054a270f32dc11df7c5e24b259a09fddf7bfaa5f33df9fb4a29642
 03cd45edab8716ebbfdb754e65fea72e873c73dc91aec098fe4a01e35324ac7a
 5858b1760fbe21848121b826b2463a67ac5a45caf3d73105497a68618c5a6fa6
 cdf04d07c3600860e8c2ebaad4e8f52ac3feb212453c1764a49ac08c827e8443
 581a682a7102a41421e7e484303572c565c1b8e52b1cc9fecd3c159dbe9a02f4
 d2ce38e95773345d0eceffed5ecb0e5d49fe61da5e922dea754c85799cc512b3
 5641bea96b9e59a173639c118c2745fe16014c60012117ddf29c18abbb713408
 471b576a4c285758d27cc4a6f1b41afa29bfb9f3754a37f0520b35b6958eb8ce
 78fe7cc32115f0669a45d7c90faaf39f7ce3939e39e2e7e5f14c17fe4bff0676
 45a5e295590c469a49b2804bfdb89059e942d768ad3b813f484d7b5bff48d226
 ce063f3286e717b3914728ad23ec7db0a0f117ba3ade5ada8a250700779f6e77
 157d21de9d055ab9e8ea3186d91e7f4f865e11f42deafa952d90842671fc2576
 6026f61089b73fa1b5ee737e95314f41cb512609b393530385ed281d0b46c062
 545f5da4bd7757e82b8a23ce3af9500c6ffeedbcb13429fca436ad1e80bd10cf
 dae60c17a479781f44a4010701833f1829140b1eeccd258762a74974aa06e19b
"

# other upstream packages
_upstream+="
 https://github.com/fplll/fpylll/releases/download/0.5.6/fpylll-0.5.6.tar.gz
 http://users.ox.ac.uk/~coml0531/sage/graphs-20210214.tar.bz2
 https://github.com/sagemath/sagetex/releases/download/v3.5/sagetex-3.5.tar.gz
 https://github.com/sagemath/threejs-sage/archive/refs/tags/r122.tar.gz>threejs-sage-r122.tar.gz
"
checksum+="
 c69bf4b3344f60ca40743af9b9246ce51f651c2cf54d2b88a4deff18b1b5f246
 07237c0d9853611505c389fd7bb92500c8743f5631babb4d0f45dfd8332f3741
 3a7454002ddff9bf862d139130c27de0416bbc2378e1f4de4eb50d805ee96779
 718767ab55876a3e957d1cfe89a322c6d9fa680fc737b9ca668aee6a3eac3bb8
"

for u in ${_upstream}; do
	distfiles+=" $u"
	skip_extraction+=" ${u##*[/>]}"
done

# for now, just build native; we'll worry about cross later
# besides, some dependencies are nocross (e.g. ntl)
nocross=yes

# for now, to make install faster
nostrip=yes

# don't shlib_provide anything
noshlibprovides=yes

# don't rewrite python shebang as sage uses its own python (for now)
#_no_python_shebang=yes

# compile python code in sage venv
pycompile_dirs="$_SAGE_ROOT/venv/"

post_extract() {
	# sage wants to be built in place so let $wrksrc be a symlink
	rm -rf $_SAGE_ROOT
	mv -T $wrksrc $_SAGE_ROOT
	ln -srfT $_SAGE_ROOT $wrksrc

	mkdir -p $wrksrc/upstream
	for u in ${_upstream}; do
		cp "$XBPS_SRCDISTDIR/${pkgname}-${version}/${u##*[/>]}" $wrksrc/upstream
	done
}

do_clean() {
	rm -rf $wrksrc $_SAGE_ROOT
}

pre_configure() {
	./bootstrap

	if [ "$build_option_debug" ]; then
		export SAGE_DEBUG=yes
	fi

	export MAKE="make -j ${XBPS_MAKEJOBS}"
}

post_configure() {
	# we set some variables, right after configure has created sage_conf.py
	cat <<-EOF >> pkgs/sage-conf/sage_conf.py
	GAP_ROOT_DIR = "/usr/share/gap"
	GAP_SO = "$(objdump -p /usr/lib/libgap.so | awk '/SONAME/{print $2}')"
	EOF
}

do_install() {
	vlicense COPYING.txt
	vdoc README.md
	vmkdir $_SAGE_ROOT
	vcopy "VERSION.txt prefix sage venv" $_SAGE_ROOT
	vmkdir $_SAGE_ROOT/local
	for f in bin include lib share; do
		vcopy local/$f $_SAGE_ROOT/local
	done
	vmkdir $_SAGE_ROOT/$(readlink venv)
	for f in pyvenv.cfg bin etc lib share; do
		vcopy venv/$f $_SAGE_ROOT/venv/
	done
	vcopy "src" $_SAGE_ROOT # only src/sage ?

	# not needed ?
	# Maybe pkgs/sagemath-standard/build/cythonized for debug
	#vcopy "build pkgs" $_SAGE_ROOT

	# symlink main binary
	vmkdir usr/bin
	# for now use sage-${version}_${revision} so it doesn't override
	# other sage installed in the system
	ln -sfT $_SAGE_ROOT/sage ${DESTDIR}/usr/bin/sage-${version}
	ln -sfT sage-${version} ${DESTDIR}/usr/bin/sage
}

do_check() {
	if [ -f ${XBPS_DISTDIR}/sagemath-check ] ; then
		_test_args=$(sed -e 's/#.*//;/^\s*$/d' ${XBPS_DISTDIR}/sagemath-check)
	fi
	if [ -z "$_test_args" ]; then
		_test_args=--all
	fi
	if [ "$XBPS_BUILD_ENVIRONMENT" = void-packages-ci ]; then
		# for CI use a predictable random seed
		_test_args="--random-seed=0 $_test_args"
	fi
	if [ "$XBPS_CHECK_PKGS" = full ]; then
		_test_args="--long $_test_args"
	else
		_test_args="--warn-long 5.0 $_test_args"
	fi
	# since make check will build the docs, run test like this instead
	./sage -tp ${XBPS_MAKEJOBS} ${_test_args}
}

### copied from sage-deps, to be kept in sync

# hard dependencies
makedepends+=" gcc make m4 perl binutils git tar libgomp-devel"

# recommended dependencies
makedepends+=" gcc-fortran openssl-devel"

# bootstrap dependencies
makedepends+=" automake gettext gettext-devel"

# other host dependencies
makedepends+=" cmake curl git ninja pandoc patch pkg-config python3 tox"

# standard dependencies
makedepends+="
 CoinMP-devel R arb-devel boost-devel bzip2-devel ecl eclib-devel
 ecm-devel flintlib-devel freetype-devel gc-devel gd-devel giac-devel
 glpk-devel gmp-devel gmpxx-devel gp2c graphviz graphviz-devel gsl-devel
 isl-devel libatomic_ops-devel libcurl-devel libffi-devel libmpc-devel
 libpng-devel libxml2-devel mpfr-devel ncurses-devel openblas-devel
 pari-devel pari-elldata-small pari-galdata pari-galpol-small
 pari-seadata pcre-devel perl-File-Slurp perl-JSON perl-Term-ReadKey
 perl-Term-ReadLine-Gnu perl-XML-LibXML perl-XML-LibXSLT
 perl-XML-Writer ppl-devel python3-devel readline-devel sqlite-devel
 zeromq-devel zlib-devel
 FlintQS SuiteSparse-devel cddlib-devel fflas-ffpack fplll-devel gf2x-devel
 givaro-devel igraph-devel iml-devel lcalc-devel linbox-devel
 m4ri-devel m4rie-devel mpfi-devel ntl-devel perl-SVG rankwidth-devel
 singular sympow zn_poly symmetrica-devel planarity-devel qhull libqhull-devel
 gengetopt texinfo
 brial-devel cliquer-devel gfan libbraiding-devel libhomfly-devel
 lrcalc-devel nauty-devel palp tachyon
 maxima-ecl primesieve-devel primecount-devel gap-devel
"

# optional dependencies
makedepends+="
 ffmpeg ImageMagick
"

# TODO: optional
# 4ti2 coxeter3 libsemigroups lrslib pdf2svg perl_mongodb polymake

# python packages for trac-29665
_sage_python3_modules="
 python3-Babel python3-Jinja2 python3-MarkupSafe python3-Pillow
 python3-Pygments python3-Sphinx python3-alabaster python3-argcomplete
 python3-argon2 python3-attrs python3-backcall python3-beniget
 python3-bleach python3-certifi python3-cffi python3-charset-normalizer
 python3-cycler python3-dateutil python3-decorator python3-defusedxml
 python3-docutils python3-entrypoints python3-flit_core python3-gast
 python3-gmpy2 python3-html5lib python3-idna python3-imagesize
 python3-importlib_metadata python3-ipython python3-ipython_genutils
 python3-ipython_ipykernel python3-jedi python3-jsonschema
 python3-jupyter_client python3-jupyter_core python3-jupyter_ipywidgets
 python3-jupyter_nbconvert python3-jupyter_nbformat
 python3-jupyter_notebook python3-jupyterlab_pygments python3-kiwisolver
 python3-matplotlib python3-matplotlib-inline python3-mistune
 python3-mpmath python3-nbclient python3-nest_asyncio python3-networkx
 python3-numpy python3-packaging python3-pandocfilters python3-parsing
 python3-parso python3-pexpect python3-pickleshare python3-pip
 python3-pkgconfig python3-pluggy python3-ply python3-prometheus_client
 python3-prompt_toolkit python3-ptyprocess python3-py python3-pybind11
 python3-pycparser python3-pyrsistent python3-pytz python3-pyzmq
 python3-requests python3-scipy python3-send2trash python3-setuptools
 python3-setuptools_scm python3-simplegeneric python3-six
 python3-snowballstemmer python3-sphinxcontrib-applehelp
 python3-sphinxcontrib-devhelp python3-sphinxcontrib-htmlhelp
 python3-sphinxcontrib-jsmath python3-sphinxcontrib-qthelp
 python3-sphinxcontrib-serializinghtml python3-sympy python3-terminado
 python3-testpath python3-texttable python3-toml python3-tomli
 python3-tornado python3-traitlets python3-typing_extensions
 python3-tzlocal python3-urllib3 python3-wcwidth python3-webencodings
 python3-wheel python3-zipp pythran

 python3-cvxopt python3-importlib_resources
 "

# python packages are build and runtime dependencies
makedepends+=" $_sage_python3_modules"
depends+=" $_sage_python3_modules"
